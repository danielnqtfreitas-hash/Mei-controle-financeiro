<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEI Controle Financeiro</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Phosphor Icons for ICONS -->
    <script src="https://unpkg.com/@phosphor-icons/web@2.1.1"></script>
    
    <!-- PDF Export Libraries (NOVO) -->
    <!-- REMOVIDO html2canvas, ADICIONADO jspdf-autotable para tabelas profissionais -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Custom Neon Green Theme and Improved Contrast */
        :root {
            --neon-green: #00ff88;
            --dark-bg: #0a0a0a; /* Mais escuro para melhor contraste */
            --dark-card: #181818;
            --dark-input: #2a2a2a;
            --dark-text: #f0f0f0;
        }
        body {
            background-color: var(--dark-bg);
            color: var(--dark-text);
            font-family: 'Inter', sans-serif;
        }
        .neon-glow {
            box-shadow: 0 0 5px var(--neon-green), 0 0 10px rgba(0, 255, 136, 0.4);
            border-color: var(--neon-green) !important;
        }
        .neon-text {
            color: var(--neon-green);
            text-shadow: 0 0 5px rgba(0, 255, 136, 0.6);
        }
        .tab-active {
            border-bottom: 3px solid var(--neon-green);
            color: var(--neon-green);
            text-shadow: 0 0 3px rgba(0, 255, 136, 0.4);
        }
        .card {
            background-color: var(--dark-card);
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #222; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #666; }

        /* Estilo do Modal/Overlay */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        /* Cor de destaque para Pró-Labore */
        .prolabore-text {
            color: #ffdd00; /* Um amarelo-dourado */
            text-shadow: 0 0 5px rgba(255, 221, 0, 0.4);
        }
        /* Cor de destaque para Notas Emitidas */
        .notas-text {
            color: #7f5cff; /* Roxo */
            text-shadow: 0 0 5px rgba(127, 92, 255, 0.4);
        }
         /* Estilos para a área de upload */
        .drop-area {
            border: 3px dashed #3b82f6;
            background-color: #121212;
            transition: all 0.2s;
        }
        .drop-area.dragover {
            border-color: var(--neon-green);
            background-color: #1a1a1a;
        }
        .file-card {
            background-color: #2a2a2a;
        }
    </style>
</head>
<body class="min-h-screen antialiased">

    <!-- Header and User Info -->
    <header class="card p-4 shadow-xl mb-4">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <h1 class="text-2xl font-bold neon-text">MEI Controle (Acesso Público)</h1>
            <div id="auth-status" class="text-xs mt-2 sm:mt-0 opacity-70">
                <p>Status: Conectado ao Painel Global.</p>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="sticky top-0 z-10 card shadow-lg">
        <div class="flex overflow-x-auto custom-scrollbar">
            <button data-tab="faturamento" class="tab-button tab-active px-4 py-3 text-sm font-medium whitespace-nowrap transition duration-300 hover:bg-[#282828] active:scale-[0.98]">
                <i class="ph-bold ph-trend-up mr-2"></i>Faturamento
            </button>
            <button data-tab="despesas" class="tab-button px-4 py-3 text-sm font-medium whitespace-nowrap transition duration-300 hover:bg-[#282828] active:scale-[0.98]">
                <i class="ph-bold ph-trend-down mr-2"></i>Despesas
            </button>
            <button data-tab="prolabore" class="tab-button px-4 py-3 text-sm font-medium whitespace-nowrap transition duration-300 hover:bg-[#282828] active:scale-[0.98]">
                <i class="ph-bold ph-wallet-fill mr-2"></i>Pró-Labore
            </button>
            <button data-tab="notasemitidas" class="tab-button px-4 py-3 text-sm font-medium whitespace-nowrap transition duration-300 hover:bg-[#282828] active:scale-[0.98]">
                <i class="ph-bold ph-receipt mr-2"></i>Notas Emitidas
            </button>
            <button data-tab="comprovantes" class="tab-button px-4 py-3 text-sm font-medium whitespace-nowrap transition duration-300 hover:bg-[#282828] active:scale-[0.98]">
                <i class="ph-bold ph-file-text-fill mr-2"></i>Comprovantes
            </button>
            <button data-tab="estoque" class="tab-button px-4 py-3 text-sm font-medium whitespace-nowrap transition duration-300 hover:bg-[#282828] active:scale-[0.98]">
                <i class="ph-bold ph-box mr-2"></i>Estoque
            </button>
            <button data-tab="das" class="tab-button px-4 py-3 text-sm font-medium whitespace-nowrap transition duration-300 hover:bg-[#282828] active:scale-[0.98]">
                <i class="ph-bold ph-receipt-magnifying-glass mr-2"></i>Resumo DAS
            </button>
            <button data-tab="dashboard" class="tab-button px-4 py-3 text-sm font-medium whitespace-nowrap transition duration-300 hover:bg-[#282828] active:scale-[0.98]">
                <i class="ph-bold ph-gauge mr-2"></i>Resumo Geral
            </button>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="p-4 sm:p-6">
        <div id="content-container">
            <!-- Tab content will be rendered here -->
            <div id="faturamento" class="tab-content" style="display: none;"></div>
            <div id="despesas" class="tab-content" style="display: none;"></div>
            <div id="prolabore" class="tab-content" style="display: none;"></div>
            <div id="notasemitidas" class="tab-content" style="display: none;"></div>
            <div id="comprovantes" class="tab-content" style="display: none;"></div>
            <div id="estoque" class="tab-content" style="display: none;"></div>
            <div id="das" class="tab-content" style="display: none;"></div>
            <div id="dashboard" class="tab-content" style="display: none;"></div>
        </div>
    </main>
    
    <!-- Floating Action Button (FAB) -->
    <button id="fab-button" 
            class="fixed bottom-6 right-6 z-30 w-16 h-16 rounded-full bg-[#00ff88] text-2xl text-[#121212] font-bold shadow-2xl transition duration-300 hover:scale-105 active:scale-90 neon-glow touch-action-manipulation"
            aria-label="Adicionar Novo Item">
        <i class="ph-bold ph-plus"></i>
    </button>
    
    <!-- Modal Container for Forms -->
    <div id="entry-modal" class="modal-overlay fixed inset-0 z-40 hidden flex items-center justify-center p-4 transition-opacity duration-300 opacity-0" onclick="if(event.target.id === 'entry-modal') closeModal()">
        <div class="card w-full max-w-lg lg:max-w-3xl p-6 rounded-xl shadow-2xl transform translate-y-4 opacity-0 transition-all duration-300" id="modal-content">
            <div class="flex justify-between items-center mb-4 border-b pb-2 border-[#333]">
                <h3 class="text-xl font-semibold neon-text" id="modal-title">Novo Registro</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-[#2a2a2a] active:scale-95 touch-action-manipulation" aria-label="Fechar Modal">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div id="modal-form-container">
                <!-- Form will be injected here -->
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

    <!-- Firebase and Application Logic -->
    <script type="module">
        // =================================================================
        // FIREBASE IMPORTS
        // =================================================================
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // --- CONFIGURAÇÃO INICIAL E VARIÁVEIS GLOBAIS ---
        
        // =================================================================
        // CONFIGURAÇÃO DO FIREBASE: Prioriza variáveis do Canvas, usa Fallback
        // =================================================================
        
        const canvasAppId = typeof __app_id !== 'undefined' ? __app_id : null;
        const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const fallbackFirebaseConfig = {
            // Configurações de fallback... (mantidas para garantir a execução)
            apiKey: "AIzaSyBI7Zecb-2tn3zUAAhiO5UmtTGcAALUiKg",
            authDomain: "vitrine-913c6.firebaseapp.com",
            projectId: "vitrine-913c6",
            storageBucket: "vitrine-913c6.appspot.com",
            messagingSenderId: "1088927815489",
            appId: "1:1088927815489:web:61d745609fbf4c8b9e73c0",
        };

        const firebaseConfig = canvasFirebaseConfig || fallbackFirebaseConfig;
        const appId = canvasAppId || firebaseConfig.projectId; 
        
        let app, db, auth, storage; // 'storage' inicializado
        let userId = null; 
        const isAppReady = true; 
        
        // Estado da Aplicação (Dados e UI)
        window.state = {
            faturamento: [],
            despesas: [],
            prolabore: [], 
            notasemitidas: [],
            comprovantes: [], // Coleção de comprovantes
            estoque: [],
            das: [],
            activeTab: 'faturamento',
            dashboardGranularity: 'month',
            dashboardMonthYearFilter: '',
        };

        // UI Element References
        const tabButtons = document.querySelectorAll('.tab-button');
        const toastContainer = document.getElementById('toast-container');
        const entryModal = document.getElementById('entry-modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalFormContainer = document.getElementById('modal-form-container');
        const fabButton = document.getElementById('fab-button');

        setLogLevel('debug'); // Ativa logs do Firestore para ajudar na depuração.

        // --- UTILITIES E HELPERS ---

        const getCollectionPath = (collectionName) => {
            return `artifacts/${appId}/public/data/${collectionName}`;
        };

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(amount);
        };

        const showToast = (message, type = 'success') => {
            const colors = type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-blue-600');
            const icon = type === 'success' ? 'ph-check-circle' : (type === 'error' ? 'ph-x-circle' : 'ph-info');
            
            const toast = document.createElement('div');
            toast.className = `p-3 mb-2 rounded-lg shadow-xl text-white ${colors} transition-all duration-300 transform translate-y-full opacity-0`;
            toast.innerHTML = `<i class="ph-bold ${icon} mr-2"></i>${message}`;
            
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('translate-y-full', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('translate-y-full', 'opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        };

        const filterDataByMonthYear = (data, dateKey, monthYearFilter) => {
            const safeData = Array.isArray(data) ? data : []; 
            
            if (!monthYearFilter) return safeData;
            
            const [year, month] = monthYearFilter.split('-').map(Number);
            
            return safeData.filter(item => { 
                const dateString = item[dateKey];
                if (!dateString) return false;
                
                const date = new Date(dateString);
                // Ajusta a data para evitar problemas de fuso horário com 'YYYY-MM-DD'
                const safeDate = new Date(date.getTime() + (24 * 60 * 60 * 1000));
                return safeDate.getFullYear() === year && (safeDate.getMonth() + 1) === month;
            });
        };


        const filterAndSortData = (data, search, monthYear, dateKey = 'data') => {
            let filtered = filterDataByMonthYear(data, dateKey, monthYear); 
            
            if (search) {
                const lowerSearch = search.toLowerCase();
                filtered = filtered.filter(item => 
                    Object.values(item).some(value => 
                        String(value).toLowerCase().includes(lowerSearch)
                    )
                );
            }
            filtered.sort((a, b) => new Date(b[dateKey] || 0) - new Date(a[dateKey] || 0));
            return filtered;
        };
        
        /**
         * Retorna os comprovantes que não estão vinculados a nenhum registro de Faturamento ou Despesa.
         * @returns {Array} Lista de comprovantes desvinculados.
         */
        const getUnlinkedComprovantes = () => {
            // Um comprovante é considerado "unlinked" se não tiver a propriedade 'linkedTo'
            return state.comprovantes.filter(c => !c.linkedTo);
        };
        
        /**
         * Gera o HTML para o seletor de comprovantes.
         * @param {string} currentComprovanteId ID do comprovante já vinculado (para edição).
         * @returns {string} HTML do select.
         */
        const getComprovantesSelectHTML = (currentComprovanteId = null) => {
            const unlinked = getUnlinkedComprovantes().sort((a, b) => new Date(b.dataUpload) - new Date(a.dataUpload));
            const currentComprovante = state.comprovantes.find(c => c.id === currentComprovanteId);

            let options = `<option value="">-- Sem Comprovante Anexado (Opcional) --</option>`;
            
            // Adiciona o comprovante atual na lista se estiver em modo de edição
            if (currentComprovante) {
                // Adiciona a opção selecionada se estiver vinculado (garantindo que o usuário veja o link atual)
                options += `<option value="${currentComprovante.id}" selected>VINCLADO (Atual): ${currentComprovante.nomeArquivo} (${currentComprovante.dataUpload})</option>`;
            }

            // Adiciona comprovantes não vinculados
            options += unlinked.map(c => 
                `<option value="${c.id}">${c.nomeArquivo} (${c.dataUpload})</option>`
            ).join('');

            return options;
        };
        
        /**
         * Atualiza o documento Comprovante marcando-o como vinculado.
         * @param {string} newComprovanteId ID do comprovante no Firestore.
         * @param {string} linkedTo Valor no formato 'colecao:docId' (Ex: 'faturamento:abcde').
         * @param {string} oldComprovanteId ID do comprovante que estava vinculado antes (para desvincular).
         */
        const updateDocumentComprovanteLink = async (newComprovanteId, linkedTo, oldComprovanteId) => {
            if (!db) return;

            // 1. Desvincular o comprovante antigo
            if (oldComprovanteId && oldComprovanteId !== newComprovanteId) {
                try {
                     await setDoc(doc(db, getCollectionPath('comprovantes'), oldComprovanteId), { linkedTo: null }, { merge: true });
                } catch (e) {
                    console.error("Erro ao desvincular comprovante antigo:", e);
                }
            }

            // 2. Vincular o novo comprovante (se houver um novo ID e for diferente do antigo)
            if (newComprovanteId && newComprovanteId !== oldComprovanteId) {
                try {
                    const comprovanteRef = doc(db, getCollectionPath('comprovantes'), newComprovanteId);
                    await setDoc(comprovanteRef, { linkedTo: linkedTo, updatedAt: serverTimestamp() }, { merge: true });
                } catch (error) {
                    console.error("Erro ao vincular novo comprovante:", error);
                    showToast(`Erro ao vincular comprovante: ${error.message}`, 'error');
                }
            }
        };


        // --- FIREBASE INICIALIZAÇÃO E LISTENERS ---

        const initializeFirebase = async () => {
            try {
                if (getApps().length === 0) {
                    app = initializeApp(firebaseConfig);
                } else {
                    app = getApp();
                }
                
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app); // Inicializa Storage

                // Tenta autenticar
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Monitora o estado da autenticação
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase e Autenticação prontos. User ID:", userId);
                    } else {
                        userId = null;
                        console.log("Usuário deslogado ou anônimo.");
                    }
                });
                
                setupFirestoreListeners();
                render('dashboard');

            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                showToast(`Erro Crítico na conexão: ${error.message}`, 'error');
            }
        };

        const setupFirestoreListeners = () => {
            if (!db) {
                console.warn("Firestore não está pronto.");
                return;
            }
            
            // Faturamento
            onSnapshot(collection(db, getCollectionPath('faturamento')), (snapshot) => {
                state.faturamento = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['faturamento', 'dashboard'].includes(state.activeTab)) render(state.activeTab);
            }, (error) => console.error("Erro no listener de Faturamento:", error));

            // Despesas
            onSnapshot(collection(db, getCollectionPath('despesas')), (snapshot) => {
                state.despesas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['despesas', 'dashboard'].includes(state.activeTab)) render(state.activeTab);
            }, (error) => console.error("Erro no listener de Despesas:", error));
            
            // Pró-Labore
            onSnapshot(collection(db, getCollectionPath('prolabore')), (snapshot) => {
                state.prolabore = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['prolabore', 'dashboard'].includes(state.activeTab)) render(state.activeTab);
            }, (error) => console.error("Erro no listener de Pró-Labore:", error));
            
            // Notas Emitidas
            onSnapshot(collection(db, getCollectionPath('notasemitidas')), (snapshot) => {
                state.notasemitidas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['notasemitidas'].includes(state.activeTab)) render('notasemitidas');
            }, (error) => console.error("Erro no listener de Notas Emitidas:", error));

            // Comprovantes (Atualiza todas as abas que usam dados de link)
            onSnapshot(collection(db, getCollectionPath('comprovantes')), (snapshot) => {
                state.comprovantes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['comprovantes', 'faturamento', 'despesas'].includes(state.activeTab)) render(state.activeTab);
            }, (error) => console.error("Erro no listener de Comprovantes:", error));


            // Estoque
            onSnapshot(collection(db, getCollectionPath('estoque')), (snapshot) => {
                state.estoque = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.activeTab === 'estoque') render('estoque');
            }, (error) => console.error("Erro no listener de Estoque:", error));
            
            // DAS
            onSnapshot(collection(db, getCollectionPath('das')), (snapshot) => {
                state.das = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.activeTab === 'das') render('das');
            }, (error) => console.error("Erro no listener de DAS:", error));
        };

        // --- OPERAÇÕES CRUD E FORMS ---

        const saveDocument = async (collectionName, data, id = null) => {
            if (!isAppReady) {
                showToast('Erro: Aplicação Firebase não pronta.', 'error');
                return;
            }

            const collectionPath = getCollectionPath(collectionName);
            if (!collectionPath) {
                showToast('Erro: Caminho da coleção inválido.', 'error');
                return;
            }
            
            // Salva o documento principal
            let docRef;
            try {
                if (id) {
                    docRef = doc(db, collectionPath, id);
                    await setDoc(docRef, { ...data, updatedAt: serverTimestamp() }, { merge: true });
                    showToast(`Item ${collectionName} atualizado com sucesso!`);
                    return id; 
                } else {
                    docRef = await addDoc(collection(db, collectionPath), { ...data, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
                    showToast(`Novo item ${collectionName} adicionado!`);
                    return docRef.id; 
                }
                
            } catch (error) {
                console.error(`Erro ao salvar em ${collectionName}:`, error);
                showToast(`Erro ao salvar: ${error.message}. Verifique as Regras de Segurança do Firestore!`, 'error');
                return null;
            }
        };

        const deleteDocument = async (collectionName, id) => {
            if (!isAppReady) {
                showToast('Erro: Aplicação Firebase não pronta.', 'error');
                return;
            }
            
            const collectionPath = getCollectionPath(collectionName);
            if (!collectionPath) {
                showToast('Erro: Caminho da coleção inválido.', 'error');
                return;
            }

            try {
                // Se for Faturamento ou Despesa, verifica se há comprovante anexado para desvincular
                if (collectionName === 'faturamento' || collectionName === 'despesas') {
                    const itemToDelete = state[collectionName].find(item => item.id === id);
                    if (itemToDelete && itemToDelete.comprovanteId) {
                        await setDoc(doc(db, getCollectionPath('comprovantes'), itemToDelete.comprovanteId), { linkedTo: null }, { merge: true });
                    }
                }
                
                // Se for Comprovante, verifica se está vinculado a algo e notifica
                if (collectionName === 'comprovantes') {
                    const itemToDelete = state[collectionName].find(item => item.id === id);
                    if (itemToDelete && itemToDelete.linkedTo) {
                         const [linkedCollection, linkedId] = itemToDelete.linkedTo.split(':');
                         if (linkedCollection && linkedId) {
                             // Tenta desvincular do item principal (limpando o comprovanteId)
                             await setDoc(doc(db, getCollectionPath(linkedCollection), linkedId), { comprovanteId: null }, { merge: true });
                         }
                    }
                }

                await deleteDoc(doc(db, collectionPath, id));
                showToast('Item excluído com sucesso!', 'success');
            } catch (error) {
                console.error(`Erro ao deletar em ${collectionName}:`, error);
                showToast(`Erro ao deletar: ${error.message}. Verifique as Regras de Segurança do Firestore!`, 'error');
            }
        };

        /**
         * Abre o modal de entrada/edição com base na coleção e, opcionalmente, nos dados para preenchimento.
         * @param {string} collectionName Nome da coleção.
         * @param {Object} data Dados para pré-preenchimento (modo edição).
         */
        window.openEntryModal = (collectionName, data = {}) => {
            let title = data.id ? `Editar Registro (${collectionName})` : 'Novo Registro';
            let formHtml = '';
            
            switch(collectionName) {
                case 'faturamento': title = data.id ? 'Editar Venda/Receita' : 'Nova Venda/Receita'; formHtml = getFaturamentoFormHTML(data); break;
                case 'despesas': title = data.id ? 'Editar Despesa' : 'Nova Despesa'; formHtml = getDespesasFormHTML(data); break;
                case 'prolabore': title = data.id ? 'Editar Pró-Labore' : 'Registro de Pró-Labore'; formHtml = getProLaboreFormHTML(data); break;
                case 'notasemitidas': title = data.id ? 'Editar Nota Fiscal' : 'Registro de Nota Fiscal Emitida'; formHtml = getNotasEmitidasFormHTML(data); break;
                case 'comprovantes': 
                    title = 'Upload de Comprovante (Imagem/PDF)'; 
                    formHtml = getComprovantesFormHTML(); 
                    break; 
                case 'estoque': title = data.id ? 'Editar Item de Estoque' : 'Novo Item de Estoque'; formHtml = getEstoqueFormHTML(data); break;
                case 'das': title = data.id ? 'Editar Pagamento DAS' : 'Registro de Pagamento DAS'; formHtml = getDasFormHTML(data); break;
                default: showToast('Funcionalidade de adição/edição não disponível para esta aba.', 'error'); return;
            }

            modalTitle.textContent = title;
            modalFormContainer.innerHTML = formHtml;
            
            // --- Handlers de Formulário ---
            if (collectionName === 'faturamento') document.getElementById('modal-form').onsubmit = handleFaturamentoSubmit;
            if (collectionName === 'despesas') document.getElementById('modal-form').onsubmit = handleDespesasSubmit;
            if (collectionName === 'prolabore') document.getElementById('modal-form').onsubmit = handleProLaboreSubmit;
            if (collectionName === 'notasemitidas') document.getElementById('modal-form').onsubmit = handleNotasEmitidasSubmit;
            if (collectionName === 'estoque') document.getElementById('modal-form').onsubmit = handleEstoqueSubmit;
            if (collectionName === 'das') document.getElementById('modal-form').onsubmit = handleDasSubmit;
            if (collectionName === 'comprovantes') setupComprovantesDragDrop();

            // Preenche a data se não estiver em edição (data vazia)
            if (!data.id) {
                const today = new Date().toISOString().split('T')[0];
                document.querySelectorAll('#modal-form input[type="date"]').forEach(input => input.value = today);
            }

            entryModal.classList.remove('hidden');
            setTimeout(() => {
                entryModal.classList.remove('opacity-0');
                modalContent.classList.remove('translate-y-4', 'opacity-0');
            }, 10);
        };
        
        /**
         * Função principal para abrir o modal de edição, buscando os dados do item.
         */
        window.openEditModal = (collectionName, id) => {
            const data = window.state[collectionName].find(item => item.id === id);
            if (!data) {
                showToast(`Item com ID ${id} não encontrado em ${collectionName}.`, 'error');
                return;
            }
            window.openEntryModal(collectionName, data);
        };

        window.closeModal = () => {
            modalContent.classList.add('translate-y-4', 'opacity-0');
            entryModal.classList.add('opacity-0');
            entryModal.addEventListener('transitionend', () => {
                entryModal.classList.add('hidden');
                modalFormContainer.innerHTML = '';
            }, { once: true });
        };
        
        // --- RENDERIZAÇÃO DE FORMULÁRIOS (MODIFICADOS PARA EDIÇÃO) ---

        const getInputClasses = () => 'p-3 rounded-lg bg-[#2a2a2a] border border-[#333] focus:border-neon-green focus:ring-1 focus:ring-neon-green text-sm w-full';
        
        const getSubmitButton = (label, icon) => `
            <button type="submit" class="w-full mt-6 px-6 py-3 bg-[#00ff88] text-lg text-black font-bold rounded-xl hover:bg-opacity-90 transition active:scale-95 neon-glow touch-action-manipulation">
                <i class="ph-bold ${icon} mr-2"></i>${label}
            </button>
        `;

        // MODIFICADO: Adicionado campo para comprovante e preenchimento de dados
        const getFaturamentoFormHTML = (data = {}) => {
            const idInput = data.id ? `<input type="hidden" name="id" value="${data.id}">` : '';
            const oldComprovanteIdInput = data.comprovanteId ? `<input type="hidden" name="oldComprovanteId" value="${data.comprovanteId}">` : '';
            
            return `
                <form id="modal-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    ${idInput}
                    ${oldComprovanteIdInput}
                    <div>
                        <label for="fat-data" class="block text-sm font-medium text-gray-400 mb-1">Data da Venda</label>
                        <input type="date" name="data" id="fat-data" required value="${data.data || ''}" class="${getInputClasses()}">
                    </div>
                    <div>
                        <label for="fat-cliente" class="block text-sm font-medium text-gray-400 mb-1">Cliente (Opcional)</label>
                        <input type="text" name="cliente" id="fat-cliente" placeholder="Nome ou Referência" value="${data.cliente || ''}" class="${getInputClasses()}">
                    </div>
                    <div class="col-span-full">
                        <label for="fat-descricao" class="block text-sm font-medium text-gray-400 mb-1">Descrição do Item/Serviço</label>
                        <input type="text" name="descricao" id="fat-descricao" required value="${data.descricao || ''}" class="${getInputClasses()}">
                    </div>
                    <div>
                        <label for="fat-pagamento" class="block text-sm font-medium text-gray-400 mb-1">Meio de Pagamento</label>
                        <select name="pagamento" id="fat-pagamento" class="${getInputClasses()}">
                            ${['Cartão', 'Pix', 'Dinheiro', 'Boleto', 'Outro'].map(opt => 
                                `<option value="${opt}" ${data.pagamento === opt ? 'selected' : ''}>${opt}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="fat-valor" class="block text-sm font-medium text-gray-400 mb-1">Valor Venda (R$)</label>
                        <input type="number" step="0.01" name="valor" id="fat-valor" placeholder="100.00" required value="${data.valor || ''}" class="${getInputClasses()}">
                    </div>
                    <div>
                        <label for="fat-custo" class="block text-sm font-medium text-gray-400 mb-1">Custo do Item/Serviço (R$)</label>
                        <input type="number" step="0.01" name="custo" id="fat-custo" placeholder="0.00" value="${data.custo || 0.00}" class="${getInputClasses()}">
                    </div>
                    <div class="col-span-full">
                        <label for="fat-comprovante" class="block text-sm font-medium text-gray-400 mb-1">Anexar Comprovante (Opcional)</label>
                        <select name="comprovanteId" id="fat-comprovante" class="${getInputClasses()}">
                            ${getComprovantesSelectHTML(data.comprovanteId)}
                        </select>
                        <button type="button" onclick="window.openEntryModal('comprovantes')" class="text-xs text-gray-500 mt-1 hover:text-neon-green transition duration-200">
                            <i class="ph-bold ph-paperclip"></i> Adicionar novo arquivo?
                        </button>
                    </div>
                    ${getSubmitButton(data.id ? 'Atualizar Venda' : 'Salvar Venda', data.id ? 'ph-check' : 'ph-plus-circle')}
                </form>
            `;
        };

        // MODIFICADO: Adicionado campo para comprovante e preenchimento de dados
        const getDespesasFormHTML = (data = {}) => {
            const idInput = data.id ? `<input type="hidden" name="id" value="${data.id}">` : '';
            const oldComprovanteIdInput = data.comprovanteId ? `<input type="hidden" name="oldComprovanteId" value="${data.comprovanteId}">` : '';

            return `
                <form id="modal-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    ${idInput}
                    ${oldComprovanteIdInput}
                    <div>
                        <label for="des-data" class="block text-sm font-medium text-gray-400 mb-1">Data da Despesa</label>
                        <input type="date" name="data" id="des-data" required value="${data.data || ''}" class="${getInputClasses()}">
                    </div>
                    <div>
                        <label for="des-tipo" class="block text-sm font-medium text-gray-400 mb-1">Tipo de Despesa</label>
                        <select name="tipo" id="des-tipo" class="${getInputClasses()}">
                            ${['Aluguel', 'Serviços', 'Marketing', 'Impostos', 'Contabilidade', 'Outros'].map(opt => 
                                `<option value="${opt}" ${data.tipo === opt ? 'selected' : ''}>${opt}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="col-span-full">
                        <label for="des-descricao" class="block text-sm font-medium text-gray-400 mb-1">Descrição da Despesa</label>
                        <input type="text" name="descricao" id="des-descricao" required value="${data.descricao || ''}" class="${getInputClasses()}">
                    </div>
                    <div>
                        <label for="des-pagamento" class="block text-sm font-medium text-gray-400 mb-1">Meio de Pagamento</label>
                        <select name="pagamento" id="des-pagamento" class="${getInputClasses()}">
                            ${['Cartão', 'Pix', 'Dinheiro', 'Boleto', 'Transferência', 'Outro'].map(opt => 
                                `<option value="${opt}" ${data.pagamento === opt ? 'selected' : ''}>${opt}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="des-valor" class="block text-sm font-medium text-gray-400 mb-1">Valor (R$)</label>
                        <input type="number" step="0.01" name="valor" id="des-valor" placeholder="50.00" required value="${data.valor || ''}" class="${getInputClasses()}">
                    </div>
                    <div>
                        <label for="des-comprovante" class="block text-sm font-medium text-gray-400 mb-1">Anexar Comprovante (Opcional)</label>
                        <select name="comprovanteId" id="des-comprovante" class="${getInputClasses()}">
                            ${getComprovantesSelectHTML(data.comprovanteId)}
                        </select>
                        <button type="button" onclick="window.openEntryModal('comprovantes')" class="text-xs text-gray-500 mt-1 hover:text-neon-green transition duration-200">
                            <i class="ph-bold ph-paperclip"></i> Adicionar novo arquivo?
                        </button>
                    </div>
                    ${getSubmitButton(data.id ? 'Atualizar Despesa' : 'Salvar Despesa', data.id ? 'ph-check' : 'ph-trend-down')}
                </form>
            `;
        };

        // MODIFICADO: Preenchimento de dados
        const getProLaboreFormHTML = (data = {}) => `
            <form id="modal-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                ${data.id ? `<input type="hidden" name="id" value="${data.id}">` : ''}
                <div>
                    <label for="pl-data" class="block text-sm font-medium text-gray-400 mb-1">Data da Retirada</label>
                    <input type="date" name="data" id="pl-data" required value="${data.data || ''}" class="${getInputClasses()}">
                </div>
                <div>
                    <label for="pl-valor" class="block text-sm font-medium text-gray-400 mb-1">Valor Retirado (R$)</label>
                    <input type="number" step="0.01" name="valor" id="pl-valor" placeholder="1000.00" required value="${data.valor || ''}" class="${getInputClasses()}">
                </div>
                <div class="col-span-full">
                    <label for="pl-descricao" class="block text-sm font-medium text-gray-400 mb-1">Descrição (Ex: Retirada Mensal, Adiantamento)</label>
                    <input type="text" name="descricao" id="pl-descricao" required value="${data.descricao || ''}" class="${getInputClasses()}">
                </div>
                ${getSubmitButton(data.id ? 'Atualizar Retirada' : 'Registrar Retirada', data.id ? 'ph-check' : 'ph-wallet-fill')}
            </form>
        `;

        // MODIFICADO: Preenchimento de dados
        const getNotasEmitidasFormHTML = (data = {}) => `
            <form id="modal-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                ${data.id ? `<input type="hidden" name="id" value="${data.id}">` : ''}
                <div>
                    <label for="ne-data" class="block text-sm font-medium text-gray-400 mb-1">Data da Emissão</label>
                    <input type="date" name="dataEmissao" id="ne-data" required value="${data.dataEmissao || ''}" class="${getInputClasses()}">
                </div>
                <div>
                    <label for="ne-nf" class="block text-sm font-medium text-gray-400 mb-1">Número da NF</label>
                    <input type="text" name="numeroNF" id="ne-nf" placeholder="Ex: 000123" required value="${data.numeroNF || ''}" class="${getInputClasses()}">
                </div>
                <div class="col-span-full">
                    <label for="ne-cliente" class="block text-sm font-medium text-gray-400 mb-1">Cliente/Tomador do Serviço</label>
                    <input type="text" name="cliente" id="ne-cliente" placeholder="Nome ou CNPJ" required value="${data.cliente || ''}" class="${getInputClasses()}">
                </div>
                <div>
                    <label for="ne-valor" class="block text-sm font-medium text-gray-400 mb-1">Valor Total da NF (R$)</label>
                    <input type="number" step="0.01" name="valor" id="ne-valor" placeholder="1500.00" required value="${data.valor || ''}" class="${getInputClasses()}">
                </div>
                <div>
                    <label for="ne-descricao" class="block text-sm font-medium text-gray-400 mb-1">Serviço/Produto Faturado</label>
                    <input type="text" name="descricao" id="ne-descricao" placeholder="Referência do contrato ou serviço" required value="${data.descricao || ''}" class="${getInputClasses()}">
                </div>
                ${getSubmitButton(data.id ? 'Atualizar Nota Fiscal' : 'Salvar Nota Fiscal', data.id ? 'ph-check' : 'ph-receipt')}
            </form>
        `;

        // MODIFICADO: Preenchimento de dados
        const getEstoqueFormHTML = (data = {}) => `
            <form id="modal-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                ${data.id ? `<input type="hidden" name="id" value="${data.id}">` : ''}
                <div class="col-span-full">
                    <label for="est-item" class="block text-sm font-medium text-gray-400 mb-1">Nome do Item</label>
                    <input type="text" name="item" id="est-item" required value="${data.item || ''}" class="${getInputClasses()}">
                </div>
                <div>
                    <label for="est-quantidade" class="block text-sm font-medium text-gray-400 mb-1">Quantidade Atual</label>
                    <input type="number" name="quantidade" id="est-quantidade" placeholder="Ex: 10" required value="${data.quantidade || ''}" class="${getInputClasses()}">
                </div>
                <div>
                    <label for="est-custounitario" class="block text-sm font-medium text-gray-400 mb-1">Custo Unitário (R$)</label>
                    <input type="number" step="0.01" name="custoUnitario" id="est-custounitario" placeholder="Ex: 15.50" required value="${data.custoUnitario || ''}" class="${getInputClasses()}">
                </div>
                ${getSubmitButton(data.id ? 'Atualizar Estoque' : 'Adicionar/Atualizar Estoque', data.id ? 'ph-check' : 'ph-box-add')}
            </form>
        `;

        // MODIFICADO: Preenchimento de dados
        const getDasFormHTML = (data = {}) => `
            <form id="modal-form" class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                ${data.id ? `<input type="hidden" name="id" value="${data.id}">` : ''}
                <div>
                    <label for="das-mes" class="block text-sm font-medium text-gray-400 mb-1">Mês de Referência</label>
                    <input type="month" name="mesReferencia" id="das-mes" required value="${data.mesReferencia || ''}" class="${getInputClasses()}">
                </div>
                <div>
                    <label for="das-valor" class="block text-sm font-medium text-gray-400 mb-1">Valor DAS Pago (R$)</label>
                    <input type="number" step="0.01" name="valorDas" id="das-valor" required value="${data.valorDas || ''}" class="${getInputClasses()}">
                </div>
                <div>
                    <label for="das-pagoem" class="block text-sm font-medium text-gray-400 mb-1">Data de Pagamento</label>
                    <input type="date" name="pagoEm" id="das-pagoem" required value="${data.pagoEm || ''}" class="${getInputClasses()}">
                </div>
                ${getSubmitButton(data.id ? 'Atualizar Pagamento DAS' : 'Registrar Pagamento DAS', data.id ? 'ph-check' : 'ph-wallet')}
            </form>
        `;

        // Formulário de Upload de Comprovantes (inalterado)
        const getComprovantesFormHTML = () => `
            <form id="modal-form" onsubmit="event.preventDefault()">
                <div id="dropArea" class="drop-area flex flex-col items-center justify-center p-8 rounded-lg cursor-pointer transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-blue-500 mb-3 neon-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    <p class="text-gray-200 font-medium text-center">Arraste e Solte o arquivo aqui</p>
                    <p class="text-sm text-gray-400 mt-1">ou clique para selecionar (JPG, PNG ou PDF)</p>
                    <input type="file" id="comprovanteFileInput" accept="image/*, application/pdf" multiple class="hidden">
                    <div id="uploadStatus" class="mt-4 text-sm text-gray-400">Aguardando arquivo...</div>
                    <div id="progressBarContainer" class="w-full mt-2 h-2 bg-[#2a2a2a] rounded-full hidden">
                        <div id="progressBar" class="h-2 bg-[#00ff88] rounded-full transition-all duration-300" style="width: 0%;"></div>
                    </div>
                </div>
            </form>
        `;

        // --- SUBMIT HANDLERS (MODIFICADOS PARA EDIÇÃO E VÍNCULO) ---
        
        // MODIFICADO: Inclui tratamento para ID, comprovanteId e oldComprovanteId
        const handleFaturamentoSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            
            const id = form.id?.value || null;
            const oldComprovanteId = form.oldComprovanteId?.value || null;
            const newComprovanteId = form.comprovanteId.value || null;

            const valor = parseFloat(form.valor.value);
            const custo = parseFloat(form.custo.value || 0);

            const newEntry = {
                data: form.data.value, cliente: form.cliente.value || 'N/A', descricao: form.descricao.value,
                pagamento: form.pagamento.value, valor: valor, custo: custo, 
                lucro: valor - custo,
                comprovanteId: newComprovanteId || null,
            };
            
            const savedDocId = await saveDocument('faturamento', newEntry, id);
            
            if (savedDocId) {
                if (newComprovanteId !== oldComprovanteId) {
                    await updateDocumentComprovanteLink(newComprovanteId, `faturamento:${savedDocId}`, oldComprovanteId);
                }
                window.closeModal();
            }
        };

        // MODIFICADO: Inclui tratamento para ID, comprovanteId e oldComprovanteId
        const handleDespesasSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            
            const id = form.id?.value || null;
            const oldComprovanteId = form.oldComprovanteId?.value || null;
            const newComprovanteId = form.comprovanteId.value || null;

            const newEntry = {
                data: form.data.value, tipo: form.tipo.value, descricao: form.descricao.value,
                pagamento: form.pagamento.value, valor: parseFloat(form.valor.value),
                comprovanteId: newComprovanteId || null,
            };
            
            const savedDocId = await saveDocument('despesas', newEntry, id);

            if (savedDocId) {
                if (newComprovanteId !== oldComprovanteId) {
                    await updateDocumentComprovanteLink(newComprovanteId, `despesas:${savedDocId}`, oldComprovanteId);
                }
                window.closeModal();
            }
        };
        
        // MODIFICADO: Inclui tratamento para ID
        const handleProLaboreSubmit = (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.id?.value || null;

            const newEntry = {
                data: form.data.value, descricao: form.descricao.value, valor: parseFloat(form.valor.value),
            };
            saveDocument('prolabore', newEntry, id).then(() => window.closeModal());
        };
        
        // MODIFICADO: Inclui tratamento para ID
        const handleNotasEmitidasSubmit = (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.id?.value || null;

            const newEntry = {
                dataEmissao: form.dataEmissao.value, numeroNF: form.numeroNF.value, cliente: form.cliente.value,
                valor: parseFloat(form.valor.value), descricao: form.descricao.value,
            };
            saveDocument('notasemitidas', newEntry, id).then(() => window.closeModal());
        };

        // MODIFICADO: Inclui tratamento para ID
        const handleEstoqueSubmit = (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.id?.value || null;
            const quantidade = parseFloat(form.quantidade.value);
            const custoUnitario = parseFloat(form.custoUnitario.value);
            const total = quantidade * custoUnitario;

            const newItem = {
                item: form.item.value, quantidade: quantidade, custoUnitario: custoUnitario, total: total,
            };
            
            // Lógica de update/insert baseada no ID ou no nome do item
            if (id) {
                saveDocument('estoque', newItem, id).then(() => window.closeModal());
            } else {
                const existingItem = state.estoque.find(i => i.item && i.item.toLowerCase() === newItem.item.toLowerCase());
                saveDocument('estoque', newItem, existingItem ? existingItem.id : null).then(() => window.closeModal());
            }
        };

        // MODIFICADO: Inclui tratamento para ID
        const handleDasSubmit = (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.id?.value || null;
            
            const newEntry = {
                mesReferencia: form.mesReferencia.value, valorDas: parseFloat(form.valorDas.value), pagoEm: form.pagoEm.value,
            };

            if (id) {
                saveDocument('das', newEntry, id).then(() => window.closeModal());
            } else {
                const existingItem = state.das.find(i => i.mesReferencia === newEntry.mesReferencia);
                saveDocument('das', newEntry, existingItem ? existingItem.id : null).then(() => window.closeModal());
            }
        };
        
        // --- LÓGICA DE UPLOAD DE ARQUIVOS ---
        
        function setupComprovantesDragDrop() {
            const dropArea = document.getElementById('dropArea');
            const fileInput = document.getElementById('comprovanteFileInput');
            
            if (!dropArea || !fileInput) return;

            // Limpa handlers antigos antes de adicionar novos
            dropArea.onclick = () => fileInput.click(); 

            fileInput.onchange = (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]); 
                    // Reset do input para permitir upload do mesmo arquivo
                    e.target.value = '';
                }
            };

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults (e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
            });

            dropArea.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                if (dt.files.length > 0) {
                    handleFileUpload(dt.files[0]);
                }
            }, false);
        }

        async function handleFileUpload(file) {
            if (!userId || !storage) {
                showToast('Erro: Usuário não autenticado ou Storage não inicializado. Tente recarregar.', 'error');
                return;
            }
            
            const uploadStatus = document.getElementById('uploadStatus');
            const progressBarContainer = document.getElementById('progressBarContainer');
            const progressBar = document.getElementById('progressBar');
            
            if (!file.type.match('image.*') && file.type !== 'application/pdf') {
                showToast('Tipo de arquivo não suportado. Use JPG, PNG ou PDF.', 'error');
                return;
            }
            
            const fileName = file.name;
            const timestamp = Date.now();
            // O caminho de Storage usa o userId para garantir que cada usuário tenha sua própria pasta
            const storagePath = `comprovantes/${userId}/${timestamp}_${fileName}`; 
            const storageRef = ref(storage, storagePath);

            uploadStatus.textContent = `Iniciando upload de ${fileName}...`;
            progressBarContainer.classList.remove('hidden');
            progressBar.style.width = '0%'; // Garante que a barra comece do zero

            // Usando uploadBytesResumable para rastrear o progresso
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    // 1. Monitora o progresso
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = progress.toFixed(0) + '%';
                    uploadStatus.textContent = `Upload: ${progress.toFixed(0)}% concluído...`;
                }, 
                (error) => {
                    // 2. Trata Erros 
                    console.error("Erro no upload ou Storage Rules:", error);
                    showToast(`Falha no upload! Erro: ${error.code} (Verifique Regras de Segurança do Storage)`, 'error');
                    progressBarContainer.classList.add('hidden');
                }, 
                async () => {
                    // 3. Conclusão do Upload
                    try {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);

                        const newComprovante = {
                            nomeArquivo: fileName,
                            tipoArquivo: file.type,
                            dataUpload: new Date().toISOString().split('T')[0],
                            url: downloadURL,
                            tamanho: file.size, 
                            linkedTo: null, 
                        };

                        await addDoc(collection(db, getCollectionPath('comprovantes')), { 
                            ...newComprovante, 
                            createdAt: serverTimestamp() 
                        });
                        
                        progressBar.style.width = '100%';
                        showToast(`Comprovante "${fileName}" enviado e registrado!`, 'success');
                        window.closeModal();

                    } catch (firestoreError) {
                        console.error("Erro ao registrar no Firestore após upload:", firestoreError);
                        showToast(`Upload OK, mas falha ao registrar no Firestore: ${firestoreError.message}`, 'error');
                    } finally {
                        progressBarContainer.classList.add('hidden');
                        progressBar.style.width = '0%';
                        uploadStatus.textContent = 'Aguardando arquivo...';
                    }
                }
            );
        }
        
        /**
         * Abre a URL do comprovante em uma nova aba.
         * @param {string} comprovanteId ID do documento de comprovante no Firestore.
         */
        window.openLinkedComprovante = (comprovanteId) => {
            const comprovante = state.comprovantes.find(c => c.id === comprovanteId);
            if (comprovante && comprovante.url) {
                // Decodificação para lidar com URLs de Storage que podem ter caracteres especiais
                window.open(decodeURIComponent(comprovante.url), '_blank');
            } else {
                showToast('URL do comprovante não encontrada.', 'error');
            }
        };


        // --- FUNÇÃO AUXILIAR: ESTRUTURA PARA EXPORTAÇÃO PDF ---
        const getExportTableStructure = (collectionName, data) => {
            const headers = [];
            const body = [];
            let totalRow = null;
            let dateKey = 'data';
            
            // Define a estrutura e formata os dados
            switch (collectionName) {
                case 'faturamento':
                    dateKey = 'data';
                    headers.push("Data", "Cliente", "Descrição", "Pagamento", "Valor (R$)", "Custo (R$)", "Lucro (R$)");
                    
                    data.forEach(item => {
                        const valor = parseFloat(item.valor || 0);
                        const custo = parseFloat(item.custo || 0);
                        const lucro = valor - custo;
                        body.push([
                            item.data ? new Date(item.data + 'T00:00:00').toLocaleDateString('pt-BR') : '-',
                            item.cliente || 'N/A',
                            item.descricao,
                            item.pagamento,
                            formatCurrency(valor),
                            formatCurrency(custo),
                            formatCurrency(lucro),
                        ]);
                    });

                    const totalFaturamento = data.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
                    const totalCusto = data.reduce((sum, item) => sum + parseFloat(item.custo || 0), 0);
                    const totalLucro = totalFaturamento - totalCusto;
                    totalRow = [
                        { content: 'TOTAIS NO PERÍODO:', colSpan: 4, styles: { fontStyle: 'bold', halign: 'right' } },
                        { content: formatCurrency(totalFaturamento), styles: { fontStyle: 'bold', fillColor: [200, 255, 220] } },
                        { content: formatCurrency(totalCusto), styles: { fontStyle: 'bold', fillColor: [255, 230, 230] } },
                        { content: formatCurrency(totalLucro), styles: { fontStyle: 'bold', fillColor: totalLucro >= 0 ? [200, 255, 220] : [255, 230, 230] } },
                    ];
                    break;

                case 'despesas':
                    dateKey = 'data';
                    headers.push("Data", "Tipo", "Descrição", "Pagamento", "Valor (R$)");
                    
                    data.forEach(item => {
                        body.push([
                            item.data ? new Date(item.data + 'T00:00:00').toLocaleDateString('pt-BR') : '-',
                            item.tipo,
                            item.descricao,
                            item.pagamento,
                            formatCurrency(parseFloat(item.valor || 0)),
                        ]);
                    });

                    const totalDespesas = data.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
                    totalRow = [
                        { content: 'TOTAL DE DESPESAS NO PERÍODO:', colSpan: 4, styles: { fontStyle: 'bold', halign: 'right' } },
                        { content: formatCurrency(totalDespesas), styles: { fontStyle: 'bold', fillColor: [255, 230, 230] } },
                    ];
                    break;
                    
                case 'prolabore':
                    dateKey = 'data';
                    headers.push("Data", "Descrição", "Valor Retirado (R$)");
                    
                    data.forEach(item => {
                        body.push([
                            item.data ? new Date(item.data + 'T00:00:00').toLocaleDateString('pt-BR') : '-',
                            item.descricao,
                            formatCurrency(parseFloat(item.valor || 0)),
                        ]);
                    });

                    const totalProlabore = data.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
                    totalRow = [
                        { content: 'TOTAL DE PRÓ-LABORE NO PERÍODO:', colSpan: 2, styles: { fontStyle: 'bold', halign: 'right' } },
                        { content: formatCurrency(totalProlabore), styles: { fontStyle: 'bold', fillColor: [255, 255, 200] } },
                    ];
                    break;

                case 'notasemitidas':
                    dateKey = 'dataEmissao';
                    headers.push("Emissão", "Nº NF", "Cliente", "Descrição", "Valor (R$)");
                    
                    data.forEach(item => {
                        body.push([
                            item.dataEmissao ? new Date(item.dataEmissao + 'T00:00:00').toLocaleDateString('pt-BR') : '-',
                            item.numeroNF,
                            item.cliente,
                            item.descricao,
                            formatCurrency(parseFloat(item.valor || 0)),
                        ]);
                    });

                    const totalNotas = data.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
                    totalRow = [
                        { content: 'TOTAL DE NOTAS EMITIDAS NO PERÍODO:', colSpan: 4, styles: { fontStyle: 'bold', halign: 'right' } },
                        { content: formatCurrency(totalNotas), styles: { fontStyle: 'bold', fillColor: [230, 230, 255] } },
                    ];
                    break;
                    
                case 'estoque':
                    dateKey = 'item'; // Não usado, mas necessário
                    headers.push("Item", "Quantidade", "Custo Unitário (R$)", "Total (R$)");
                    
                    data.forEach(item => {
                         const custoUnitario = parseFloat(item.custoUnitario || 0);
                         const total = parseFloat(item.total || 0);
                        body.push([
                            item.item,
                            item.quantidade,
                            formatCurrency(custoUnitario),
                            formatCurrency(total),
                        ]);
                    });

                    const totalEstoque = data.reduce((sum, item) => sum + parseFloat(item.total || 0), 0);
                    totalRow = [
                        { content: 'VALOR TOTAL DO ESTOQUE:', colSpan: 3, styles: { fontStyle: 'bold', halign: 'right' } },
                        { content: formatCurrency(totalEstoque), styles: { fontStyle: 'bold', fillColor: [200, 255, 220] } },
                    ];
                    break;

                case 'das':
                    dateKey = 'pagoEm';
                    headers.push("Mês Ref.", "Valor DAS (R$)", "Pago em");
                    
                    data.forEach(item => {
                        const [year, month] = item.mesReferencia.split('-');
                        const mesRefFormatado = `${month}/${year}`;
                        
                        body.push([
                            mesRefFormatado,
                            formatCurrency(parseFloat(item.valorDas || 0)),
                            item.pagoEm ? new Date(item.pagoEm + 'T00:00:00').toLocaleDateString('pt-BR') : '-',
                        ]);
                    });

                    const totalDas = data.reduce((sum, item) => sum + parseFloat(item.valorDas || 0), 0);
                    totalRow = [
                        { content: 'TOTAL DAS PAGO:', colSpan: 1, styles: { fontStyle: 'bold', halign: 'right' } },
                        { content: formatCurrency(totalDas), styles: { fontStyle: 'bold', fillColor: [255, 230, 230] } },
                        { content: '', colSpan: 1 }
                    ];
                    break;
            }

            return { headers, body, totalRow, dateKey };
        };


        // --- FUNÇÃO DE EXPORTAÇÃO PARA PDF (REFACTOR) ---
        window.exportToPDF = async (collectionName, title) => {
            const exportButton = document.getElementById(`export-pdf-btn-${collectionName}`);
            const originalText = exportButton.innerHTML;
            
            exportButton.disabled = true;
            exportButton.innerHTML = '<i class="ph-bold ph-spinner-gap animate-spin mr-2"></i> Gerando PDF...';

            try {
                const { jsPDF } = window.jspdf;
                // Usa 'l' (landscape) para que caiba mais colunas, como no Faturamento
                const pdf = new jsPDF('l', 'mm', 'a4'); 
                
                // 1. Obter Dados Filtrados
                const dateKey = collectionName === 'notasemitidas' ? 'dataEmissao' : (collectionName === 'das' ? 'pagoEm' : 'data');
                const monthYearFilter = document.getElementById(`${collectionName}-month-year`)?.value;
                const searchFilter = document.getElementById(`${collectionName}-search`)?.value;
                const filteredData = filterAndSortData(state[collectionName], searchFilter, monthYearFilter, dateKey);

                if (filteredData.length === 0) {
                    showToast("Nenhum dado encontrado para exportar com os filtros atuais.", 'error');
                    return;
                }
                
                const { headers, body, totalRow } = getExportTableStructure(collectionName, filteredData);

                // 2. Título e Metadata
                pdf.setFontSize(20);
                pdf.setTextColor(40, 40, 40);
                pdf.text(`Relatório MEI: ${title}`, 15, 20);

                pdf.setFontSize(10);
                const filterInfo = `Filtros: Mês/Ano: ${monthYearFilter || 'Todos'} | Busca: ${searchFilter || 'Nenhuma'}`;
                pdf.text(filterInfo, 15, 28);
                pdf.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}`, 15, 33);
                
                const finalBody = body;
                if (totalRow) {
                    finalBody.push(totalRow);
                }

                // 3. AutoTable (Geração da Tabela)
                pdf.autoTable({
                    head: [headers],
                    body: finalBody,
                    startY: 40,
                    theme: 'striped', // Tema profissional e limpo
                    styles: { fontSize: 8, cellPadding: 2, textColor: [50, 50, 50] },
                    headStyles: { fillColor: [200, 200, 200], textColor: [0, 0, 0], fontStyle: 'bold' },
                    margin: { top: 10, right: 15, bottom: 10, left: 15 },
                    // Footer/Header para numeração de página
                    didDrawPage: function(data) {
                        pdf.setFontSize(8);
                        const pageCount = pdf.internal.getNumberOfPages();
                        // Footer
                        pdf.text(`Página ${data.pageNumber} de ${pageCount}`, data.settings.margin.left, pdf.internal.pageSize.height - 10);
                    }
                });

                // 4. Salvar (Baixar para a memória do dispositivo)
                const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                const fileName = `${collectionName}_Relatorio_${date}.pdf`;
                pdf.save(fileName);

                showToast(`PDF '${fileName}' gerado e baixado!`, 'success');
                
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                showToast(`Erro ao exportar: ${error.message}`, 'error');
            } finally {
                exportButton.disabled = false;
                exportButton.innerHTML = originalText;
            }
        };


        // --- RENDERIZAÇÃO DE TABELAS (MODIFICADA PARA BOTÃO DE EXPORTAR) ---

        const renderControls = (collectionName, title) => {
            const dateKey = collectionName === 'notasemitidas' ? 'dataEmissao' : (collectionName === 'das' ? 'pagoEm' : 'data');
            
            return `
                <div class="flex flex-col sm:flex-row gap-4 mb-6 card p-4 rounded-xl border border-[#333]">
                    <!-- Busca Rápida -->
                    <div class="flex-grow">
                        <label for="${collectionName}-search" class="block text-sm font-medium text-gray-400 mb-1">Busca Rápida</label>
                        <input type="text" id="${collectionName}-search" placeholder="Buscar por descrição, cliente, etc." 
                               class="w-full p-2.5 rounded-lg bg-[#2a2a2a] border border-[#444] focus:border-neon-green focus:ring-1 focus:ring-neon-green text-sm"
                               oninput="handleSearchFilter('${collectionName}', '${dateKey}')">
                    </div>
                    <!-- Filtro por Mês/Ano -->
                    <div class="w-full sm:w-auto">
                        <label for="${collectionName}-month-year" class="block text-sm font-medium text-gray-400 mb-1">Filtrar por Mês/Ano</label>
                        <input type="month" id="${collectionName}-month-year" value=""
                               class="w-full p-2.5 rounded-lg bg-[#2a2a2a] border border-[#444] focus:border-neon-green focus:ring-1 focus:ring-neon-green text-sm"
                               onchange="handleSearchFilter('${collectionName}', '${dateKey}')">
                        <button onclick="clearMonthFilter('${collectionName}')" class="text-xs text-gray-500 mt-1 hover:text-white transition duration-200">Limpar Filtro</button>
                    </div>
                    <!-- Botão Exportar PDF -->
                    <div class="w-full sm:w-auto flex items-end">
                        <button id="export-pdf-btn-${collectionName}"
                                onclick="exportToPDF('${collectionName}', '${title}')"
                                class="w-full sm:w-auto px-4 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition active:scale-95 text-sm"
                                aria-label="Exportar para PDF">
                            <i class="ph-bold ph-file-pdf mr-2"></i> Exportar PDF
                        </button>
                    </div>
                </div>
            `;
        };
        
        const createTableHTML = (collectionName, data, headers, dataKeys, valueColumns = []) => {
            const dateKey = collectionName === 'notasemitidas' ? 'dataEmissao' : (collectionName === 'das' ? 'pagoEm' : 'data');
            
            const filteredData = (collectionName !== 'estoque') ? 
                filterAndSortData(data, 
                    document.getElementById(`${collectionName}-search`)?.value,
                    document.getElementById(`${collectionName}-month-year`)?.value,
                    dateKey
                ) : data;

            if (filteredData.length === 0) {
                return `<div class="p-6 text-center text-gray-500 card rounded-xl">Nenhum registro encontrado.</div>`;
            }
            
            // Adiciona coluna de comprovante para Faturamento e Despesas
            const addComprovanteColumn = collectionName === 'faturamento' || collectionName === 'despesas';
            const extraHeader = addComprovanteColumn ? `<th class="p-3 text-center font-medium w-16">Arq.</th>` : '';

            // Renderiza cabeçalho dentro de THEAD
            const headerHTML = headers.map(h => `<th class="p-3 text-left font-medium">${h}</th>`).join('');
            
            const rowsHTML = filteredData.map(item => {
                const cellHTML = dataKeys.map(key => {
                    let value = item[key];
                    let displayValue = value;
                    let colorClass = '';

                    if (key.includes('data') || key.includes('Data') || key.includes('pagoEm') || key === 'mesReferencia') {
                        if (key === 'mesReferencia' && value) {
                            // Formata YYYY-MM para Mês/Ano
                            const [year, month] = value.split('-');
                            displayValue = `${month}/${year}`;
                        } else {
                            displayValue = value ? new Date(value + 'T00:00:00').toLocaleDateString('pt-BR') : '-';
                        }
                    } else if (valueColumns.includes(key)) {
                        if (collectionName === 'faturamento' && key === 'valor') colorClass = 'neon-text';
                        if (collectionName === 'faturamento' && key === 'custo') colorClass = 'text-red-400';
                        if (collectionName === 'faturamento' && key === 'lucro') colorClass = parseFloat(item[key] || 0) >= 0 ? 'neon-text' : 'text-red-400';
                        if (collectionName === 'despesas' && key === 'valor') colorClass = 'text-red-400';
                        if (collectionName === 'prolabore' && key === 'valor') colorClass = 'text-yellow-400';
                        if (collectionName === 'notasemitidas' && key === 'valor') colorClass = 'text-indigo-400';
                        displayValue = formatCurrency(parseFloat(value || 0));
                    } else if (key === 'numeroNF') {
                        colorClass = 'font-medium text-gray-300';
                    }

                    return `<td class="p-3 border-t border-[#333] ${colorClass}">${displayValue}</td>`;
                }).join('');
                
                let comprovanteCell = '';
                if (addComprovanteColumn) {
                    const comprovanteId = item.comprovanteId;
                    const iconButton = comprovanteId ? 
                        `<button onclick="event.stopPropagation(); openLinkedComprovante('${comprovanteId}')" title="Ver Comprovante Anexado" class="text-blue-400 hover:text-blue-300 p-1 rounded-full hover:bg-[#333] transition active:scale-95 touch-action-manipulation">
                            <i class="ph-bold ph-file-text text-lg"></i>
                        </button>` : 
                        `<span class="text-gray-600 p-1"><i class="ph-bold ph-file-dashed text-lg"></i></span>`;
                    
                    comprovanteCell = `<td class="p-3 border-t border-[#333] text-center">${iconButton}</td>`;
                }


                const actionsHTML = `
                    <td class="p-3 border-t border-[#333] text-right whitespace-nowrap">
                        <button onclick="openEditModal('${collectionName}', '${item.id}')" 
                                class="text-gray-400 hover:text-yellow-400 p-1 rounded-full hover:bg-[#333] transition active:scale-95 touch-action-manipulation mr-1"
                                aria-label="Editar item">
                            <i class="ph-bold ph-pencil-simple text-lg"></i>
                        </button>
                        <button onclick="deleteDocument('${collectionName}', '${item.id}')" 
                                class="text-red-500 hover:text-red-400 p-1 rounded-full hover:bg-[#333] transition active:scale-95 touch-action-manipulation"
                                aria-label="Excluir item">
                            <i class="ph-bold ph-trash text-lg"></i>
                        </button>
                    </td>
                `;

                return `<tr class="hover:bg-[#1f1f1f] transition duration-150">${cellHTML}${comprovanteCell}${actionsHTML}</tr>`;
            }).join('');
            
            let totalRowHTML = '';
            let totalValue = 0;
            let totalClass = 'text-white';
            let totalColspan = dataKeys.length; 
            
            if (collectionName === 'faturamento') {
                const totalFaturamento = filteredData.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
                const totalCusto = filteredData.reduce((sum, item) => sum + parseFloat(item.custo || 0), 0);
                const totalLucro = totalFaturamento - totalCusto;
                totalRowHTML = `
                    <tr class="font-bold text-base bg-[#282828] border-b-2 border-t-2 border-[#333]">
                        <td class="p-3 text-white" colspan="${dataKeys.length - 3}">TOTAIS NO PERÍODO:</td>
                        <td class="p-3 neon-text">${formatCurrency(totalFaturamento)}</td>
                        <td class="p-3 text-red-400">${formatCurrency(totalCusto)}</td>
                        <td class="p-3 ${totalLucro >= 0 ? 'neon-text' : 'text-red-400'}">${formatCurrency(totalLucro)}</td>
                        ${addComprovanteColumn ? '<td></td>' : ''}
                        <td class="p-3"></td>
                    </tr>
                `;
            } else if (collectionName === 'despesas') {
                totalValue = filteredData.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
                totalClass = 'text-red-400';
                totalRowHTML = `
                    <tr class="font-bold text-base bg-[#282828] border-b-2 border-t-2 border-[#333]">
                        <td class="p-3 text-white" colspan="${totalColspan - 1}">TOTAL DE DESPESAS NO PERÍODO:</td>
                        <td class="p-3 ${totalClass}">${formatCurrency(totalValue)}</td>
                        ${addComprovanteColumn ? '<td></td>' : ''}
                        <td class="p-3"></td>
                    </tr>
                `;
            } else if (collectionName === 'prolabore') {
                totalValue = filteredData.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
                totalClass = 'text-yellow-400';
                totalRowHTML = `
                    <tr class="font-bold text-base bg-[#282828] border-b-2 border-t-2 border-[#333]">
                        <td class="p-3 text-white" colspan="${totalColspan - 1}">TOTAL DE PRÓ-LABORE NO PERÍODO:</td>
                        <td class="p-3 ${totalClass}">${formatCurrency(totalValue)}</td>
                        <td class="p-3"></td>
                    </tr>
                `;
            } else if (collectionName === 'notasemitidas') {
                totalValue = filteredData.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
                totalClass = 'text-indigo-400';
                totalRowHTML = `
                    <tr class="font-bold text-base bg-[#282828] border-b-2 border-t-2 border-[#333]">
                        <td class="p-3 text-white" colspan="${totalColspan - 1}">TOTAL DE NOTAS EMITIDAS NO PERÍODO:</td>
                        <td class="p-3 ${totalClass}">${formatCurrency(totalValue)}</td>
                        <td class="p-3"></td>
                    </tr>
                `;
            }

            return `
                <div class="overflow-x-auto custom-scrollbar shadow-lg rounded-xl card mb-6 border border-[#333]">
                    <table class="min-w-full table-auto text-sm">
                        <thead class="bg-[#282828]">
                            <tr>${headerHTML}${extraHeader}<th class="p-3 text-right font-medium w-32">Ações</th></tr>
                        </thead>
                        <tbody>
                            ${rowsHTML.length > 0 && collectionName !== 'comprovantes' && totalRowHTML}
                            ${rowsHTML}
                        </tbody>
                    </table>
                </div>
            `;
        };
        
        // --- FUNÇÕES DE RENDERIZAÇÃO DE TELA (MODIFICADAS PARA USAR CONTAINER DE EXPORTAÇÃO) ---

        const renderFaturamento = () => {
            const tabEl = document.getElementById('faturamento');
            const data = state.faturamento;
            const headers = ["Data", "Cliente", "Descrição", "Pagamento", "Valor (R$)", "Custo (R$)", "Lucro (R$)"];
            const dataKeys = ["data", "cliente", "descricao", "pagamento", "valor", "custo", "lucro"];
            const valueColumns = ["valor", "custo", "lucro"];
            const title = "Registro de Faturamento (Vendas e Receitas)";
            tabEl.innerHTML = `<h2 class="text-2xl font-semibold mb-6 neon-text">${title}</h2>${renderControls('faturamento', title)}<h3 class="text-xl font-semibold mb-3 neon-text">Histórico de Transações</h3><div id="faturamento-export-container"><div id="faturamento-table-container">${createTableHTML('faturamento', data, headers, dataKeys, valueColumns)}</div></div>`;
        };

        const renderDespesas = () => {
            const tabEl = document.getElementById('despesas');
            const data = state.despesas;
            const headers = ["Data", "Tipo", "Descrição", "Pagamento", "Valor (R$)"];
            const dataKeys = ["data", "tipo", "descricao", "pagamento", "valor"];
            const valueColumns = ["valor"];
            const title = "Registro de Despesas Operacionais";
            tabEl.innerHTML = `<h2 class="text-2xl font-semibold mb-6 neon-text">${title}</h2>${renderControls('despesas', title)}<h3 class="text-xl font-semibold mb-3 neon-text">Histórico de Despesas</h3><div id="despesas-export-container"><div id="despesas-table-container">${createTableHTML('despesas', data, headers, dataKeys, valueColumns)}</div></div>`;
        };
        
        const renderProLabore = () => {
            const tabEl = document.getElementById('prolabore');
            const data = state.prolabore;
            const headers = ["Data", "Descrição", "Valor Retirado (R$)"];
            const dataKeys = ["data", "descricao", "valor"];
            const valueColumns = ["valor"];
            const title = "Controle de Pró-Labore (Retiradas do Sócio)";
            const totalProlabore = data.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
            tabEl.innerHTML = `<h2 class="text-2xl font-semibold mb-6 neon-text">${title}</h2>${renderControls('prolabore', title)}<div class="card p-4 mb-6 rounded-xl text-center border border-[#333] border-b-4 border-yellow-500"><p class="text-sm font-medium text-gray-400">Total Retirado Acumulado:</p><p class="text-3xl font-bold mt-1 text-yellow-400">${formatCurrency(totalProlabore)}</p></div><h3 class="text-xl font-semibold mb-3 neon-text">Histórico de Retiradas</h3><div id="prolabore-export-container"><div id="prolabore-table-container">${createTableHTML('prolabore', data, headers, dataKeys, valueColumns)}</div></div>`;
        };
        
        const renderNotasEmitidas = () => {
            const tabEl = document.getElementById('notasemitidas');
            const data = state.notasemitidas;
            const headers = ["Emissão", "Nº NF", "Cliente", "Descrição", "Valor (R$)"];
            const dataKeys = ["dataEmissao", "numeroNF", "cliente", "descricao", "valor"];
            const valueColumns = ["valor"];
            const title = "Registro de Notas Fiscais Emitidas";
            const totalNotas = data.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
            tabEl.innerHTML = `<h2 class="text-2xl font-semibold mb-6 neon-text">${title}</h2>${renderControls('notasemitidas', title)}<div class="card p-4 mb-6 rounded-xl text-center border border-[#333] border-b-4 border-indigo-500"><p class="text-sm font-medium text-gray-400">Total Faturado em NF:</p><p class="text-3xl font-bold mt-1 notas-text">${formatCurrency(totalNotas)}</p></div><h3 class="text-xl font-semibold mb-3 neon-text">Histórico de Notas</h3><div id="notasemitidas-export-container"><div id="notasemitidas-table-container">${createTableHTML('notasemitidas', data, headers, dataKeys, valueColumns)}</div></div>`;
        };

        const renderComprovantes = () => {
            const tabEl = document.getElementById('comprovantes');
            const data = state.comprovantes.sort((a, b) => new Date(b.dataUpload) - new Date(a.dataUpload));
            
            const comprovanteCardsHTML = data.map(item => {
                const isImage = item.tipoArquivo && item.tipoArquivo.startsWith('image/');
                const icon = isImage ? 'ph-image-square-fill' : 'ph-file-pdf-fill';
                const fileTypeColor = isImage ? 'text-blue-400' : 'text-red-400';
                
                const linked = item.linkedTo ? item.linkedTo.split(':') : null;
                const linkedCollection = linked ? (linked[0] === 'faturamento' ? 'Venda' : 'Despesa') : null;
                const linkedId = linked ? linked[1] : null;

                const linkStatus = linked ? 
                    `<p class="text-xs text-yellow-400 font-medium mt-1">Vinculado a: ${linkedCollection} (ID: ${linkedId.substring(0, 5)}...)</p>` :
                    `<p class="text-xs text-gray-500 font-medium mt-1">Status: Não Vinculado</p>`;


                return `
                    <div class="file-card p-4 rounded-xl shadow-lg flex flex-col justify-between">
                        <div class="flex items-start justify-between mb-3">
                            <i class="ph-bold ${icon} text-3xl ${fileTypeColor}"></i>
                            <button onclick="window.open(decodeURIComponent('${item.url}'), '_blank')" 
                                    class="p-1 text-gray-400 hover:text-white transition active:scale-95"
                                    aria-label="Abrir arquivo">
                                <i class="ph-bold ph-eye text-xl"></i>
                            </button>
                        </div>
                        
                        <p class="text-sm font-semibold truncate text-white mb-1">${item.nomeArquivo}</p>
                        <div class="text-xs text-gray-400">
                            <p>Upload: ${item.dataUpload ? new Date(item.dataUpload + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p>
                            ${linkStatus}
                        </div>
                        
                        <button onclick="deleteDocument('comprovantes', '${item.id}')" 
                                class="w-full mt-3 text-xs py-1 text-red-400 hover:bg-[#333] rounded-lg transition active:scale-95">
                            Excluir
                        </button>
                    </div>
                `;
            }).join('');

            tabEl.innerHTML = `
                <h2 class="text-2xl font-semibold mb-6 neon-text">Arquivos Digitais de Comprovantes</h2>
                <div class="card p-4 mb-6 rounded-xl border border-[#333]">
                    <p class="text-sm text-gray-400">Guarde aqui as fotos de notas, recibos, guias DAS e qualquer documento fiscal que você queira digitalizar. Arquivos aceitos: Imagens (JPG, PNG) e PDFs.</p>
                </div>
                
                <h3 class="text-xl font-semibold mb-3 neon-text">Documentos Armazenados (${data.length})</h3>

                ${data.length === 0 
                    ? `<div class="p-6 text-center text-gray-500 card rounded-xl">Nenhum comprovante digitalizado ainda. Clique no <i class="ph-bold ph-plus"></i> para começar!</div>`
                    : `<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">${comprovanteCardsHTML}</div>`
                }
            `;
            // Não há exportação de PDF para esta tela, pois o conteúdo é um grid de cards, não uma tabela de dados
        };

        const renderEstoque = () => {
            const tabEl = document.getElementById('estoque');
            const data = state.estoque;
            const headers = ["Item", "Quantidade", "Custo Unitário (R$)", "Total (R$)"];
            const dataKeys = ["item", "quantidade", "custoUnitario", "total"];
            const valueColumns = ["custoUnitario", "total"];
            const title = "Controle de Estoque";
            const totalEstoqueValor = data.reduce((sum, item) => sum + parseFloat(item.total || 0), 0);
            tabEl.innerHTML = `<h2 class="text-2xl font-semibold mb-6 neon-text">${title}</h2>${renderControls('estoque', title)}<div class="card p-4 mb-6 rounded-xl text-center border border-[#333]"><p class="text-sm font-medium text-gray-400">Valor Total do Estoque:</p><p class="text-3xl font-bold mt-1 neon-text">${formatCurrency(totalEstoqueValor)}</p></div><h3 class="text-xl font-semibold mb-3 neon-text">Inventário Atual</h3><div id="estoque-export-container"><div id="estoque-table-container">${createTableHTML('estoque', data, headers, dataKeys, valueColumns)}</div></div>`;
             // Remove o botão de FAB da aba estoque
            fabButton.classList.add('hidden');
        };

        const renderDas = () => {
            const tabEl = document.getElementById('das');
            const data = state.das;
            const headers = ["Mês de Referência", "Valor DAS (R$)", "Pago em"];
            const dataKeys = ["mesReferencia", "valorDas", "pagoEm"];
            const valueColumns = ["valorDas"];
            const title = "Acompanhamento da Guia DAS (MEI)";
            tabEl.innerHTML = `<h2 class="text-2xl font-semibold mb-6 neon-text">${title}</h2>${renderControls('das', title)}<h3 class="text-xl font-semibold mb-3 neon-text">Histórico de Pagamentos DAS</h3><div id="das-export-container"><div id="das-table-container">${createTableHTML('das', data, headers, dataKeys, valueColumns)}</div></div>`;
        };


        // --- DASHBOARD AND CHART LOGIC ---
        // (Mantidos inalterados)

        const calculateKPIs = (monthYearFilter) => {
            const filteredFaturamento = filterDataByMonthYear(state.faturamento, 'data', monthYearFilter);
            const filteredDespesas = filterDataByMonthYear(state.despesas, 'data', monthYearFilter);
            const filteredProlabore = filterDataByMonthYear(state.prolabore, 'data', monthYearFilter);

            const faturamentoTotal = filteredFaturamento.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
            const despesasOperacionais = filteredDespesas.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
            const custosFaturamento = filteredFaturamento.reduce((sum, item) => sum + parseFloat(item.custo || 0), 0);
            const proLaboreTotal = filteredProlabore.reduce((sum, item) => sum + parseFloat(item.valor || 0), 0);
            
            const despesasTotais = despesasOperacionais + custosFaturamento;
            const lucroLiquido = faturamentoTotal - despesasTotais;
            const lucroLiquidoFinal = lucroLiquido - proLaboreTotal;

            const proLaborePercent = faturamentoTotal > 0 ? (proLaboreTotal / faturamentoTotal) * 100 : 0;
            
            return { 
                faturamentoTotal, 
                despesasTotais, 
                lucroLiquido, 
                proLaboreTotal, 
                lucroLiquidoFinal, 
                proLaborePercent 
            };
        };

        let chartInstance = null;
        
        const renderChart = () => {
            const canvas = document.getElementById('analyticsChart');
            if (!canvas) return;

            const { dashboardGranularity: granularity, dashboardMonthYearFilter } = state;
            const aggregated = {};
            const dateKey = 'data';

            const getGroupKey = (dateStr) => {
                const date = new Date(dateStr + 'T00:00:00');
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                if (granularity === 'year') return String(year);
                if (granularity === 'month') return `${year}-${month}`;
                return `${year}-${month}-${day}`;
            };
            
            const filteredFaturamento = filterDataByMonthYear(state.faturamento, dateKey, dashboardMonthYearFilter);
            const filteredDespesas = filterDataByMonthYear(state.despesas, dateKey, dashboardMonthYearFilter);
            const filteredProlabore = filterDataByMonthYear(state.prolabore, dateKey, dashboardMonthYearFilter);

            const aggregateData = (data, targetKey, isCost = false) => {
                data.forEach(item => {
                    const key = getGroupKey(item[dateKey]);
                    if (!aggregated[key]) aggregated[key] = { faturamento: 0, despesas: 0, prolabore: 0 };
                    
                    if (isCost) {
                        aggregated[key][targetKey] += parseFloat(item.custo || 0); 
                    } else {
                        aggregated[key][targetKey] += parseFloat(item.valor || 0);
                    }
                });
            };

            aggregateData(filteredFaturamento, 'faturamento');
            aggregateData(filteredFaturamento, 'despesas', true); 
            aggregateData(filteredDespesas, 'despesas');          
            aggregateData(filteredProlabore, 'prolabore');        

            const sortedKeys = Object.keys(aggregated).sort();

            const labels = sortedKeys.map(key => {
                if (granularity === 'year') return key;
                if (granularity === 'month') return new Date(key + '-01').toLocaleDateString('pt-BR', { year: 'numeric', month: 'short' });
                return new Date(key).toLocaleDateString('pt-BR');
            });
            
            const faturamentoData = sortedKeys.map(key => aggregated[key].faturamento);
            const despesasData = sortedKeys.map(key => aggregated[key].despesas);
            const proLaboreData = sortedKeys.map(key => aggregated[key].prolabore);
            
            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'Faturamento Recebido',
                        data: faturamentoData,
                        backgroundColor: 'rgba(0, 255, 136, 0.7)',
                        borderColor: 'var(--neon-green)',
                        borderWidth: 1,
                        borderRadius: 4
                    },
                    {
                        label: 'Despesas Totais (Custos + Op.)',
                        data: despesasData,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgb(255, 99, 132)',
                        borderWidth: 1,
                        borderRadius: 4
                    },
                    {
                        type: 'line', 
                        label: 'Pró-Labore',
                        data: proLaboreData,
                        borderColor: 'rgb(255, 221, 0)',
                        backgroundColor: 'rgba(255, 221, 0, 0.2)',
                        borderWidth: 3,
                        tension: 0.3,
                        pointRadius: 5
                    }
                ]
            };

            const chartConfig = {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#333' },
                            ticks: { color: 'var(--dark-text)', callback: (value) => formatCurrency(value) }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'var(--dark-text)' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: 'var(--dark-text)', boxWidth: 12 } },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`
                            }
                        }
                    }
                }
            };
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            const ctx = canvas.getContext('2d');
            chartInstance = new Chart(ctx, chartConfig);
        };

        const renderDashboard = () => {
            const tabEl = document.getElementById('dashboard');
            const { faturamentoTotal, despesasTotais, lucroLiquido, proLaboreTotal, lucroLiquidoFinal, proLaborePercent } = calculateKPIs(state.dashboardMonthYearFilter);
            
            const profitNeonFinal = lucroLiquidoFinal >= 0 ? 'neon-text' : 'text-red-500';
            const profitNeonLiquido = lucroLiquido >= 0 ? 'text-sky-400' : 'text-red-500';

            const granularityOptions = [
                { value: 'day', label: 'Dia' },
                { value: 'month', label: 'Mês' },
                { value: 'year', label: 'Ano' }
            ];
            
            tabEl.innerHTML = `
                <h2 class="text-3xl font-bold mb-8 neon-text">Resumo Geral e Análise Financeira</h2>

                <!-- Controles de Filtro para Dashboard -->
                <div class="flex flex-col sm:flex-row gap-4 mb-8 card p-4 rounded-xl border border-[#333]">
                    <div class="w-full sm:w-1/2">
                        <label for="dashboard-month-year" class="block text-sm font-medium text-gray-400 mb-1">Filtrar Resumo por Mês/Ano</label>
                        <input type="month" id="dashboard-month-year" value="${state.dashboardMonthYearFilter || ''}"
                               class="w-full p-2.5 rounded-lg bg-[#2a2a2a] border border-[#444] focus:border-neon-green focus:ring-1 focus:ring-neon-green text-sm"
                               onchange="handleDashboardMonthFilter(this.value)">
                        <button onclick="clearDashboardMonthFilter()" class="text-xs text-gray-500 mt-1 hover:text-white transition duration-200">Limpar Filtro</button>
                    </div>
                    <div class="w-full sm:w-1/2">
                        <label for="dashboard-granularity-selector" class="block text-sm font-medium text-gray-400 mb-1">Granularidade do Gráfico</label>
                        <div id="dashboard-granularity-selector" class="flex space-x-2 mt-1">
                        ${granularityOptions.map(opt => `
                            <button onclick="changeGranularity('${opt.value}')"
                                class="px-3 py-1 text-xs font-medium rounded-full transition duration-150 active:scale-95
                                ${state.dashboardGranularity === opt.value ? 'bg-[#00ff88] text-[#121212] neon-glow' : 'bg-[#2a2a2a] text-gray-300 hover:bg-[#3a3a3a]'}">
                                ${opt.label}
                            </button>
                        `).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- KPIs (Key Performance Indicators) -->
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                    <!-- Faturamento Total (Existing) -->
                    <div class="card p-4 rounded-xl shadow-lg border-b-4 border-[#00ff88] transition hover:shadow-neon">
                        <p class="text-sm uppercase text-gray-400 font-medium">Faturamento Total (Recebido)</p>
                        <p class="text-2xl font-bold mt-1 neon-text">${formatCurrency(faturamentoTotal)}</p>
                    </div>
                    <!-- Despesas Totais (Existing) -->
                    <div class="card p-4 rounded-xl shadow-lg border-b-4 border-red-500 transition hover:shadow-red-900">
                        <p class="text-sm uppercase text-gray-400 font-medium">Despesas Totais (Custos + Op.)</p>
                        <p class="text-2xl font-bold mt-1 text-red-500">${formatCurrency(despesasTotais)}</p>
                    </div>
                    <!-- Lucro Líquido (Before Pró-Labore) - NOVO DESTAQUE -->
                    <div class="card p-4 rounded-xl shadow-lg border-b-4 border-sky-500 transition hover:shadow-sky-900">
                        <p class="text-sm uppercase text-gray-400 font-medium">Lucro Líquido (ANTES PL)</p>
                        <p class="text-2xl font-bold mt-1 ${profitNeonLiquido}">${formatCurrency(lucroLiquido)}</p>
                    </div>
                    <!-- Pró-Labore Total (NEW) -->
                    <div class="card p-4 rounded-xl shadow-lg border-b-4 border-yellow-500 transition hover:shadow-yellow-900">
                        <p class="text-sm uppercase text-gray-400 font-medium">Pró-Labore Total Retirado</p>
                        <p class="text-2xl font-bold mt-1 text-yellow-400">${formatCurrency(proLaboreTotal)}</p>
                    </div>
                </div>

                <!-- Resumo Final e Porcentagem (NEW SECTION) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="card p-6 rounded-xl shadow-lg border-b-4 ${lucroLiquidoFinal >= 0 ? 'border-[#00ff88]' : 'border-red-500'}">
                        <p class="text-lg uppercase text-gray-400 font-medium">LUCRO FINAL APÓS PRÓ-LABORE</p>
                        <p class="text-5xl font-extrabold mt-2 ${profitNeonFinal}">${formatCurrency(lucroLiquidoFinal)}</p>
                    </div>
                    <div class="card p-6 rounded-xl shadow-lg border-b-4 border-yellow-500">
                        <p class="text-lg uppercase text-gray-400 font-medium">Pró-Labore como % do Faturamento</p>
                        <p class="text-5xl font-extrabold mt-2 text-yellow-400">${proLaborePercent.toFixed(2)}%</p>
                    </div>
                </div>
                
                <!-- Gráfico Analítico -->
                <div class="card p-6 rounded-xl shadow-lg border border-[#333]">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
                        <h3 class="text-xl font-semibold neon-text">Faturamento Recebido vs Custos/Despesas/Pró-Labore (Histórico)</h3>
                    </div>
                    <div style="height: 400px; width: 100%;">
                        <canvas id="analyticsChart"></canvas>
                    </div>
                </div>
            `;
            
            setTimeout(renderChart, 50);
        };
        
        // --- LÓGICA DE NAVEGAÇÃO E RE-RENDERIZAÇÃO ---
        
        const render = (tabName) => {
            state.activeTab = tabName;
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            tabButtons.forEach(btn => btn.classList.remove('tab-active'));

            const activeContentEl = document.getElementById(tabName);
            const activeTabBtn = document.querySelector(`.tab-button[data-tab="${tabName}"]`);

            if (activeContentEl) activeContentEl.style.display = 'block';
            if (activeTabBtn) activeTabBtn.classList.add('tab-active');

            if (tabName === 'faturamento') renderFaturamento();
            if (tabName === 'despesas') renderDespesas();
            if (tabName === 'prolabore') renderProLabore();
            if (tabName === 'notasemitidas') renderNotasEmitidas();
            if (tabName === 'comprovantes') renderComprovantes(); // NOVO
            if (tabName === 'estoque') renderEstoque();
            if (tabName === 'das') renderDas();
            if (tabName === 'dashboard') renderDashboard();
            
            // O FAB só é escondido para as abas Dashboard e Estoque
            if (tabName === 'dashboard' || tabName === 'estoque' || tabName === 'comprovantes') {
                fabButton.classList.add('hidden');
                // Comprovantes usa o botão FAB para o upload
                if (tabName === 'comprovantes') {
                    fabButton.classList.remove('hidden');
                }
            } else {
                fabButton.classList.remove('hidden');
            }
            
            // Otimização para garantir que o FAB clique no modal correto
             if (tabName !== 'dashboard' && tabName !== 'estoque') {
                 fabButton.onclick = () => window.openEntryModal(state.activeTab);
             }
        };

        const setupEventListeners = () => {
            tabButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const tabName = e.currentTarget.dataset.tab;
                    render(tabName);
                });
            });
            
            // Configuração inicial do FAB (vai ser sobrescrito pelo render)
            if (fabButton) {
                fabButton.addEventListener('click', () => {
                    // Usar a aba ativa para determinar qual modal abrir
                    window.openEntryModal(state.activeTab);
                });
            }
            
            // Exposição de funções globais (necessário no ambiente Canvas)
            window.deleteDocument = deleteDocument;
            window.handleSearchFilter = handleSearchFilter;
            window.clearMonthFilter = clearMonthFilter;
            window.changeGranularity = changeGranularity;
            window.closeModal = closeModal;
            window.handleFileUpload = handleFileUpload; 
            window.openEntryModal = openEntryModal; 
            window.openEditModal = openEditModal; 
            window.openLinkedComprovante = openLinkedComprovante; 
            window.exportToPDF = exportToPDF; // EXPONDO FUNÇÃO DE EXPORTAÇÃO
            
            // Handlers de filtro do Dashboard
            window.handleDashboardMonthFilter = (value) => {
                state.dashboardMonthYearFilter = value;
                renderDashboard();
            };

            window.clearDashboardMonthFilter = () => {
                state.dashboardMonthYearFilter = '';
                renderDashboard();
            };
        };

        const handleSearchFilter = (collectionName, dateKey) => {
            const containerId = `${collectionName}-table-container`;
            const containerEl = document.getElementById(containerId);
            if (!containerEl) return;

            const data = state[collectionName];
            
            let headers, dataKeys, valueColumns;

            // Define cabeçalhos e chaves para a renderização da tabela (mantido)
            if (collectionName === 'faturamento') {
                headers = ["Data", "Cliente", "Descrição", "Pagamento", "Valor (R$)", "Custo (R$)", "Lucro (R$)"];
                dataKeys = ["data", "cliente", "descricao", "pagamento", "valor", "custo", "lucro"];
                valueColumns = ["valor", "custo", "lucro"];
            } else if (collectionName === 'despesas') {
                headers = ["Data", "Tipo", "Descrição", "Pagamento", "Valor (R$)"];
                dataKeys = ["data", "tipo", "descricao", "pagamento", "valor"];
                valueColumns = ["valor"];
            } else if (collectionName === 'prolabore') {
                headers = ["Data", "Descrição", "Valor Retirado (R$)"];
                dataKeys = ["data", "descricao", "valor"];
                valueColumns = ["valor"];
            } else if (collectionName === 'notasemitidas') {
                headers = ["Emissão", "Nº NF", "Cliente", "Descrição", "Valor (R$)"];
                dataKeys = ["dataEmissao", "numeroNF", "cliente", "descricao", "valor"];
                valueColumns = ["valor"];
            } else if (collectionName === 'das') {
                headers = ["Mês de Referência", "Valor DAS (R$)", "Pago em"];
                dataKeys = ["mesReferencia", "valorDas", "pagoEm"];
                valueColumns = ["valorDas"];
            } else if (collectionName === 'estoque') {
                 headers = ["Item", "Quantidade", "Custo Unitário (R$)", "Total (R$)"];
                 dataKeys = ["item", "quantidade", "custoUnitario", "total"];
                 valueColumns = ["custoUnitario", "total"];
            } else {
                return;
            }

            containerEl.innerHTML = createTableHTML(collectionName, data, headers, dataKeys, valueColumns);
        };

        const clearMonthFilter = (collectionName) => {
            const monthYearInput = document.getElementById(`${collectionName}-month-year`);
            if (monthYearInput) monthYearInput.value = '';
            const dateKey = collectionName === 'notasemitidas' ? 'dataEmissao' : (collectionName === 'das' ? 'pagoEm' : 'data');
            handleSearchFilter(collectionName, dateKey);
        };
        
        const changeGranularity = (granularity) => {
            state.dashboardGranularity = granularity;
            renderDashboard();
        };

        // --- INICIALIZAÇÃO ---

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();
            setupEventListeners();
        });

    </script>
</body>
</html>

